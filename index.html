<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¦™ LLAMA EVO: ICE AGE</title>
    <style>
        :root { --bg:#050510; --wall:#1a1a2e; --player:#4cc9f0; --enemy:#f72585; --accent:#fee440; --text:#e2e2e2; --coin:#ffd700; --ice:#a2d2ff; }
        body { margin:0; font-family:'Pretendard', sans-serif; background:var(--bg); color:var(--text); overflow:hidden; display:flex; flex-direction:column; align-items:center; touch-action:none; }
        #header { padding: 10px; font-weight: 800; background: rgba(0,0,0,0.8); width: 100%; text-align: center; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #333; z-index: 10; }
        canvas { background:#000; border:3px solid #4cc9f0; border-radius:15px; margin: 5px 0; }
        .stat-container { display:flex; gap:10px; margin-bottom:5px; z-index: 10; }
        .stat { background:rgba(255,255,255,0.1); padding:6px 12px; border-radius:12px; font-size:0.85rem; border: 1px solid rgba(255,255,255,0.2); }
        .overlay { position:fixed; inset:0; background:var(--bg); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; text-align:center; padding:20px; overflow-y: auto; }
        .btn { width:220px; padding:12px; margin:5px; border:none; border-radius:12px; color:white; font-weight:bold; cursor:pointer; }
        .shop-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin: 5px; width: 260px; display: flex; justify-content: space-between; align-items: center; }
        .stage-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .stage-card { width: 85px; height: 85px; background: #1a1a2e; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #333; }
        .stage-card.active { border-color: var(--player); }
        #joystickContainer { position: relative; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(76,201,240,0.3); margin: 10px; }
        #joystickKnob { position: absolute; width: 40px; height: 40px; background: var(--player); border-radius: 50%; left: 30px; top: 30px; }
        #dashBar { width: 200px; height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        #dashFill { width: 100%; height: 100%; background: var(--player); }
    </style>
</head>
<body>

<div id="loginScreen" class="overlay">
    <h1 style="color:var(--player)">ğŸ¦™ LLAMA EVO</h1>
    <input type="text" id="uIn" placeholder="ID">
    <input type="password" id="pIn" placeholder="PW">
    <button class="btn" style="background:var(--player); color:black;" onclick="auth()">START</button>
</div>

<div id="menuScreen" class="overlay" style="display:none;">
    <h2 id="welcome"></h2>
    <p style="color:var(--coin)">ğŸ’° <span id="totalCoins">0</span></p>
    <div class="stage-grid" id="stageGrid"></div>
    <div id="shopUI"></div> <button class="btn" style="background:var(--player); color:black;" onclick="startGame()">ENTER STAGE</button>
</div>

<div id="header">
    <div id="stageName">STAGE 1</div>
    <div style="color:var(--coin)">ğŸ’° <span id="rCoins">0</span></div>
    <div onclick="state.isPaused = !state.isPaused" style="cursor:pointer">PAUSE</div>
</div>

<div class="stat-container">
    <div class="stat">ğŸ”‘ <span id="keys">0</span>/<span id="tKeys">0</span></div>
    <div class="stat">â¤ï¸ <span id="hp">0</span></div>
    <div class="stat">â±ï¸ <span id="timer">0.0</span></div>
</div>
<div id="dashBar"><div id="dashFill"></div></div>

<canvas id="gameCanvas"></canvas>
<div id="joystickContainer"><div id="joystickKnob"></div></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const knob = document.getElementById('joystickKnob');
const container = document.getElementById('joystickContainer');

// --- ìŠ¤í…Œì´ì§€ ë°ì´í„° (6ë²ˆ ì–¼ìŒë§µ ì¶”ê°€) ---
const STAGES = {
    1: { name: "ì´ˆì› (ê¸°ë³¸)", size: 13, keys: 3, open: 0.2, enemies: 1, coins: 5, gimmick: 'none' },
    2: { name: "ìˆ² (ì•ˆê°œ)", size: 17, keys: 5, open: 0.25, enemies: 2, coins: 10, gimmick: 'fog' },
    3: { name: "ì‚¬ë§‰ (ëŠª)", size: 21, keys: 7, open: 0.28, enemies: 3, coins: 15, gimmick: 'sand' },
    4: { name: "ë™êµ´ (í¬íƒˆ)", size: 19, keys: 6, open: 0.26, enemies: 4, coins: 20, gimmick: 'portal' },
    5: { name: "í™”ì‚° (ìš©ì•”)", size: 25, keys: 10, open: 0.32, enemies: 5, coins: 30, gimmick: 'lava' },
    6: { name: "ë¹™í•˜ (ì–¼ìŒ)", size: 23, keys: 8, open: 0.3, enemies: 4, coins: 25, gimmick: 'ice' }
};

let user = null;
let selStage = 1;
let dashGauge = 100;
let iceVelX = 0; // ì–¼ìŒìš© ì†ë„ X
let iceVelY = 0; // ì–¼ìŒìš© ì†ë„ Y

let state = { isRunning: false, isPaused: false, round: 1, maze: [], keys: 0, tKeys: 0, hp: 3, timer: 0, start: 0, coins: 0, exit: false, ts: 0 };
let player = { x: 0, y: 0, r: 0 };
let enemies = [];
let joystick = { active: false, ang: 0, force: 0 };

// --- ì¸ì¦ ë° ê¸°ë³¸ ì‹œìŠ¤í…œ ---
function auth() {
    const id = document.getElementById('uIn').value;
    const pw = document.getElementById('pIn').value;
    if(!id) return;
    let db = JSON.parse(localStorage.getItem('llama_v5_db') || "{}");
    if(!db[id]) db[id] = { pw, coins: 0, unlocked: 1, hp: 3, dash: 0.5, speed: 0.13, best: {} };
    if(db[id].pw !== pw) return alert("ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼");
    user = id;
    localStorage.setItem('llama_v5_db', JSON.stringify(db));
    refreshMenu();
}

function refreshMenu() {
    let u = JSON.parse(localStorage.getItem('llama_v5_db'))[user];
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('menuScreen').style.display = 'flex';
    document.getElementById('welcome').innerText = `HELLO, ${user}`;
    document.getElementById('totalCoins').innerText = u.coins;
    
    const grid = document.getElementById('stageGrid');
    grid.innerHTML = "";
    for(let i=1; i<=6; i++) {
        const div = document.createElement('div');
        div.className = `stage-card ${i > u.unlocked ? 'locked' : ''} ${selStage === i ? 'active' : ''}`;
        div.innerHTML = `<span>${i}</span><small>${u.best[i] || 'NEW'}</small>`;
        div.onclick = () => { if(i <= u.unlocked) { selStage = i; refreshMenu(); } };
        grid.appendChild(div);
    }
}

function startGame() {
    state.round = selStage;
    state.start = Date.now();
    state.coins = 0;
    let u = JSON.parse(localStorage.getItem('llama_v5_db'))[user];
    state.hp = u.hp;
    iceVelX = 0; iceVelY = 0; // ì–¼ìŒ ì†ë„ ì´ˆê¸°í™”
    document.getElementById('menuScreen').style.display = 'none';
    document.getElementById('stageName').innerText = STAGES[state.round].name;
    init();
    if(!state.isRunning) { state.isRunning = true; loop(); }
}

function init() {
    const d = STAGES[state.round];
    state.tKeys = d.keys; state.keys = 0; state.exit = false;
    let s = Math.min(window.innerWidth * 0.95, window.innerHeight * 0.45);
    canvas.width = canvas.height = s;
    state.ts = s / d.size;
    player.r = state.ts * 0.35;
    player.x = player.y = state.ts * 1.5;
    
    // ë¯¸ë¡œ ìƒì„± ë° ì  ë°°ì¹˜ (ì´ì „ ë¡œì§ ë™ì¼)
    state.maze = Array.from({length: d.size}, () => Array(d.size).fill(1));
    const walk = (x, y) => {
        state.maze[y][x] = 0;
        [[0,2],[0,-2],[2,0],[-2,0]].sort(()=>Math.random()-0.5).forEach(([dx,dy])=>{
            let nx=x+dx, ny=y+dy;
            if(nx>0&&nx<d.size-1&&ny>0&&ny<d.size-1&&state.maze[ny][nx]===1){
                state.maze[y+dy/2][x+dx/2]=0; walk(nx,ny);
            }
        });
    };
    walk(1,1);
    for(let y=1;y<d.size-1;y++) for(let x=1;x<d.size-1;x++) if(Math.random()<d.open) state.maze[y][x]=0;
    state.maze[d.size-2][d.size-2]=0;
    
    // ì•„ì´í…œ ë°°ì¹˜
    const f = (v, n) => {
        let count = 0;
        while(count < n) {
            let x = Math.floor(Math.random()*d.size), y = Math.floor(Math.random()*d.size);
            if(state.maze[y][x] === 0 && (x > 3 || y > 3)) { state.maze[y][x] = v; count++; }
        }
    };
    f(2, d.keys); f(3, d.coins);
    
    enemies = [];
    for(let i=0; i<d.enemies; i++) enemies.push({x:(d.size-2)*state.ts, y:(d.size-2)*state.ts, path:[], last:0});
}

function loop() {
    if(!state.isPaused) { update(); draw(); }
    requestAnimationFrame(loop);
}

function update() {
    let uData = JSON.parse(localStorage.getItem('llama_v5_db'))[user];
    let isDash = joystick.force > 0.8 && dashGauge > 10;
    let baseSpeed = state.ts * uData.speed * (isDash ? 2.2 : 1);
    let gimmick = STAGES[state.round].gimmick;

    // --- ì–¼ìŒ ë§µ ë¬¼ë¦¬ ê¸°ë¯¹ (Ice Physics) ---
    if(gimmick === 'ice') {
        if(joystick.active) {
            // ì¡°ì´ìŠ¤í‹± ë°©í–¥ìœ¼ë¡œ í˜(ê°€ì†ë„)ì„ ì¤Œ
            iceVelX += Math.cos(joystick.ang) * baseSpeed * 0.1;
            iceVelY += Math.sin(joystick.ang) * baseSpeed * 0.1;
        } else {
            // ì¡°ì´ìŠ¤í‹±ì„ ë†“ìœ¼ë©´ ì„œì„œíˆ ê°ì† (ë§ˆì°°ë ¥)
            iceVelX *= 0.98;
            iceVelY *= 0.98;
        }
        
        // ìµœëŒ€ ì†ë„ ì œí•œ
        const maxIceSpeed = baseSpeed * 1.5;
        const currentSpeed = Math.sqrt(iceVelX**2 + iceVelY**2);
        if(currentSpeed > maxIceSpeed) {
            iceVelX = (iceVelX / currentSpeed) * maxIceSpeed;
            iceVelY = (iceVelY / currentSpeed) * maxIceSpeed;
        }

        // ì‹¤ì œ ì´ë™ ë° ë²½ ì¶©ëŒ
        if(can(player.x + iceVelX, player.y)) {
            player.x += iceVelX;
        } else {
            iceVelX *= -0.5; // ë²½ì— ë¶€ë”ªíˆë©´ íŠ•ê¹€
        }
        
        if(can(player.x, player.y + iceVelY)) {
            player.y += iceVelY;
        } else {
            iceVelY *= -0.5; // ë²½ì— ë¶€ë”ªíˆë©´ íŠ•ê¹€
        }
    } else {
        // --- ì¼ë°˜ ìŠ¤í…Œì´ì§€ ì´ë™ ë¡œì§ ---
        if(joystick.active) {
            let vx = Math.cos(joystick.ang) * baseSpeed * joystick.force;
            let vy = Math.sin(joystick.ang) * baseSpeed * joystick.force;
            if(can(player.x + vx, player.y)) player.x += vx;
            if(can(player.x, player.y + vy)) player.y += vy;
        }
    }

    // ëŒ€ì‹œ ê²Œì´ì§€
    if(isDash) dashGauge -= 2; else dashGauge = Math.min(100, dashGauge + uData.dash);

    // ì•„ì´í…œ ë° í´ë¦¬ì–´ ì²´í¬
    let gx = Math.floor(player.x/state.ts), gy = Math.floor(player.y/state.ts);
    if(state.maze[gy] && state.maze[gy][gx] > 1) {
        if(state.maze[gy][gx] === 2) { state.keys++; if(state.keys >= state.tKeys) state.exit = true; }
        if(state.maze[gy][gx] === 3) state.coins++;
        state.maze[gy][gx] = 0;
    }

    // ì  ì¶”ê²©
    enemies.forEach(en => {
        if(Date.now()-en.last > 400) { en.path = find(Math.floor(en.x/state.ts), Math.floor(en.y/state.ts), gx, gy); en.last = Date.now(); }
        if(en.path.length > 0) {
            let t = en.path[0], tx = (t.x+0.5)*state.ts, ty = (t.y+0.5)*state.ts;
            let a = Math.atan2(ty-en.y, tx-en.x);
            en.x += Math.cos(a)*state.ts*0.06; en.y += Math.sin(a)*state.ts*0.06;
            if(dist(en.x, en.y, tx, ty) < 5) en.path.shift();
        }
        if(dist(en.x, en.y, player.x, player.y) < player.r*2) hit();
    });

    if(state.exit && gx === state.maze.length-2 && gy === state.maze.length-2) win();
    state.timer = ((Date.now()-state.start)/1000).toFixed(1);
    updateUI();
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let gimmick = STAGES[state.round].gimmick;

    for(let y=0; y<state.maze.length; y++) {
        for(let x=0; x<state.maze.length; x++) {
            let c = state.maze[y][x];
            if(c === 1) {
                // ì–¼ìŒ ë§µ ë°°ê²½ìƒ‰ ë‹¤ë¥´ê²Œ
                ctx.fillStyle = (gimmick === 'ice') ? '#224466' : '#1a1a2e';
                ctx.fillRect(x*state.ts, y*state.ts, state.ts, state.ts);
            } else {
                ctx.fillStyle = (gimmick === 'ice') ? '#a2d2ff' : '#050510';
                ctx.fillRect(x*state.ts, y*state.ts, state.ts, state.ts);
                if(c === 2) drawE("ğŸ”‘", x, y);
                if(c === 3) drawE("ğŸ’°", x, y);
            }
        }
    }
    if(state.exit) drawE("ğŸ", state.maze.length-2, state.maze.length-2);
    ctx.font = `${state.ts}px Arial`;
    ctx.fillText("ğŸ¦™", player.x-state.ts/2, player.y+state.ts/3);
    enemies.forEach(en => ctx.fillText("ğŸº", en.x-state.ts/2, en.y+state.ts/3));
}

// (ë‚˜ë¨¸ì§€ í—¬í¼ í•¨ìˆ˜ ë° ì¡°ì´ìŠ¤í‹± ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼)
function drawE(e, x, y) { ctx.font = `${state.ts*0.7}px Arial`; ctx.fillText(e, x*state.ts+state.ts*0.15, (y+0.8)*state.ts); }
function can(nx, ny) {
    let b = player.r*0.6;
    return [ {x:nx-b, y:ny-b}, {x:nx+b, y:ny-b}, {x:nx-b, y:ny+b}, {x:nx+b, y:ny+b} ].every(p => {
        let gx=Math.floor(p.x/state.ts), gy=Math.floor(p.y/state.ts);
        return state.maze[gy] && state.maze[gy][gx] !== 1;
    });
}
function hit() { alert("ì‹¤íŒ¨!"); location.reload(); }
function win() {
    let db = JSON.parse(localStorage.getItem('llama_v5_db'));
    db[user].coins += state.coins;
    if(state.round === db[user].unlocked && state.round < 6) db[user].unlocked++;
    db[user].best[state.round] = state.timer;
    localStorage.setItem('llama_v5_db', JSON.stringify(db));
    alert("í´ë¦¬ì–´!"); location.reload();
}
function find(sx, sy, tx, ty) {
    let q = [[{x:sx, y:sy}]], v = new Set();
    while(q.length > 0) {
        let path = q.shift(), curr = path[path.length-1];
        if(curr.x === tx && curr.y === ty) return path.slice(1);
        for(let [dx,dy] of [[0,1],[0,-1],[1,0],[-1,0]]) {
            let nx=curr.x+dx, ny=curr.y+dy;
            if(nx>=0&&nx<state.maze.length&&ny>=0&&ny<state.maze.length&&state.maze[ny][nx]!==1&&!v.has(`${nx},${ny}`)) {
                v.add(`${nx},${ny}`); q.push([...path, {x:nx, y:ny}]);
            }
        }
        if(q.length > 200) break;
    }
    return [];
}
function dist(x1, y1, x2, y2) { return Math.sqrt((x2-x1)**2 + (y2-y1)**2); }
function updateUI() {
    document.getElementById('keys').innerText = state.keys;
    document.getElementById('tKeys').innerText = state.tKeys;
    document.getElementById('hp').innerText = state.hp;
    document.getElementById('timer').innerText = state.timer;
    document.getElementById('rCoins').innerText = state.coins;
    document.getElementById('dashFill').style.width = `${dashGauge}%`;
}
container.addEventListener('pointerdown', e => { joystick.active = true; move(e); });
window.addEventListener('pointermove', e => { if(joystick.active) move(e); });
window.addEventListener('pointerup', () => { joystick.active = false; knob.style.transform = `translate(0,0)`; });
function move(e) {
    const r = container.getBoundingClientRect();
    const dx = e.clientX - (r.left + r.width/2), dy = e.clientY - (r.top + r.height/2);
    const d = Math.sqrt(dx*dx + dy*dy);
    joystick.ang = Math.atan2(dy, dx);
    joystick.force = Math.min(d/50, 1);
    knob.style.transform = `translate(${Math.cos(joystick.ang)*Math.min(d,50)}px, ${Math.sin(joystick.ang)*Math.min(d,50)}px)`;
}
</script>
</body>
</html>